<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FacilityOS ‚Äì Geb√§udemanagement</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f4f3ef; --surface: #ffffff; --surface2: #f9f8f5;
    --border: #e2e0d8; --border2: #d0cec4;
    --text: #1a1916; --text2: #5a5850; --text3: #9a9890;
    --accent: #2563eb; --accent-light: #dbeafe;
    --green: #16a34a; --green-light: #dcfce7;
    --red: #dc2626; --red-light: #fee2e2;
    --yellow: #d97706; --yellow-light: #fef3c7;
    --orange: #ea580c; --orange-light: #ffedd5;
    --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
    --radius: 10px; --sidebar-w: 240px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); font-size: 14px; line-height: 1.5; }
  button { font-family: inherit; cursor: pointer; }
  input, textarea, select { font-family: inherit; }

  .login-screen { position: fixed; inset: 0; background: var(--text); display: flex; align-items: center; justify-content: center; z-index: 999; flex-direction: column; gap: 24px; }
  .login-screen.hidden { display: none; }
  .login-box { background: #fff; border-radius: 16px; padding: 40px 48px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 380px; }
  .login-logo { font-size: 40px; margin-bottom: 12px; }
  .login-title { font-size: 22px; font-weight: 600; margin-bottom: 6px; }
  .login-sub { font-size: 13px; color: var(--text3); margin-bottom: 28px; }
  .btn-google { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 12px; border: 2px solid var(--border2); border-radius: 10px; background: #fff; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s; color: var(--text); }
  .btn-google:hover { background: var(--bg); border-color: var(--accent); }
  .btn-google img { width: 20px; height: 20px; }
  .login-hint { font-size: 11.5px; color: var(--text3); margin-top: 16px; }

  .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 500; font-size: 14px; color: var(--text2); flex-direction: column; gap: 12px; }
  .loading-overlay.hidden { display: none; }
  .spinner { width: 32px; height: 32px; border: 3px solid var(--border2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .layout { display: flex; min-height: 100vh; }
  .sidebar { width: var(--sidebar-w); background: var(--text); color: #fff; position: fixed; top: 0; left: 0; height: 100vh; display: flex; flex-direction: column; z-index: 100; overflow-y: auto; }
  .sidebar-logo { padding: 24px 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
  .sidebar-logo .logo-name { font-size: 17px; font-weight: 600; letter-spacing: -0.3px; }
  .sidebar-logo .logo-sub { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 2px; font-family: 'DM Mono', monospace; }
  .nav-section { padding: 16px 12px 8px; }
  .nav-label { font-size: 10px; font-weight: 600; letter-spacing: 0.08em; color: rgba(255,255,255,0.3); text-transform: uppercase; padding: 0 8px; margin-bottom: 4px; }
  .nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 7px; cursor: pointer; color: rgba(255,255,255,0.65); font-size: 13.5px; font-weight: 400; transition: all 0.15s; margin-bottom: 2px; border: none; background: none; width: 100%; text-align: left; }
  .nav-item:hover { background: rgba(255,255,255,0.07); color: #fff; }
  .nav-item.active { background: rgba(37,99,235,0.35); color: #fff; font-weight: 500; }
  .nav-item .nav-icon { font-size: 16px; width: 20px; text-align: center; flex-shrink: 0; }
  .nav-badge { margin-left: auto; background: var(--red); color: #fff; font-size: 10px; font-weight: 600; padding: 1px 6px; border-radius: 10px; font-family: 'DM Mono', monospace; }

  .main { margin-left: var(--sidebar-w); flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
  .topbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 28px; height: 56px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
  .topbar-title { font-size: 16px; font-weight: 600; letter-spacing: -0.2px; }
  .topbar-actions { display: flex; gap: 8px; align-items: center; }
  .page { padding: 28px; flex: 1; }
  .page-hidden { display: none; }

  .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border2); }
  .user-name { font-size: 13px; color: var(--text2); }
  .btn-logout { padding: 5px 12px; border-radius: 7px; border: 1px solid var(--border2); background: var(--surface); font-size: 12.5px; color: var(--text2); cursor: pointer; }
  .btn-logout:hover { background: var(--red-light); color: var(--red); border-color: var(--red); }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; margin-right: 6px; }
  .sync-label { font-size: 12px; color: var(--text3); display: flex; align-items: center; }

  .btn { padding: 7px 16px; border-radius: 7px; border: none; font-size: 13.5px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s; cursor: pointer; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #1d4ed8; }
  .btn-secondary { background: var(--surface); border: 1px solid var(--border2); color: var(--text2); }
  .btn-secondary:hover { background: var(--bg); }
  .btn-sm { padding: 5px 12px; font-size: 12.5px; }
  .btn-edit { background: var(--accent-light); border: 1px solid #bfdbfe; color: var(--accent); }
  .btn-edit:hover { background: #bfdbfe; }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
  .card-header { padding: 18px 20px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .card-title { font-size: 14px; font-weight: 600; }
  .card-body { padding: 20px; }

  .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .kpi-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px 20px; box-shadow: var(--shadow); }
  .kpi-label { font-size: 12px; color: var(--text3); font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
  .kpi-value { font-size: 28px; font-weight: 600; letter-spacing: -1px; line-height: 1; margin-bottom: 6px; font-family: 'DM Mono', monospace; }
  .kpi-sub { font-size: 12px; color: var(--text3); }
  .kpi-accent { border-left: 3px solid var(--accent); }
  .kpi-green { border-left: 3px solid var(--green); }
  .kpi-red { border-left: 3px solid var(--red); }
  .kpi-yellow { border-left: 3px solid var(--yellow); }

  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13.5px; }
  th { text-align: left; padding: 10px 14px; font-size: 11.5px; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 0.06em; border-bottom: 1px solid var(--border); white-space: nowrap; }
  td { padding: 11px 14px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }

  .badge { display: inline-flex; align-items: center; padding: 2px 9px; border-radius: 20px; font-size: 11.5px; font-weight: 500; white-space: nowrap; }
  .badge-green { background: var(--green-light); color: var(--green); }
  .badge-red { background: var(--red-light); color: var(--red); }
  .badge-yellow { background: var(--yellow-light); color: var(--yellow); }
  .badge-blue { background: var(--accent-light); color: var(--accent); }
  .badge-orange { background: var(--orange-light); color: var(--orange); }
  .badge-gray { background: #f1f0eb; color: var(--text2); }

  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .mb-16 { margin-bottom: 16px; }
  .mb-24 { margin-bottom: 24px; }

  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 12.5px; font-weight: 500; color: var(--text2); margin-bottom: 6px; }
  .form-input, .form-select, .form-textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--border2); border-radius: 7px; font-size: 13.5px; color: var(--text); background: var(--surface); outline: none; transition: border 0.15s; }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
  .form-textarea { resize: vertical; min-height: 80px; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 200; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
  .modal-overlay.hidden { display: none; }
  .modal { background: var(--surface); border-radius: 14px; box-shadow: 0 20px 60px rgba(0,0,0,0.18); width: 540px; max-width: 95vw; max-height: 90vh; overflow-y: auto; }
  .modal-header { padding: 22px 24px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .modal-title { font-size: 16px; font-weight: 600; }
  .modal-close { background: none; border: none; font-size: 20px; color: var(--text3); cursor: pointer; padding: 4px; border-radius: 5px; line-height: 1; }
  .modal-close:hover { color: var(--text); background: var(--bg); }
  .modal-body { padding: 24px; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }

  .tabs { display: flex; gap: 2px; background: var(--bg); padding: 4px; border-radius: 8px; margin-bottom: 20px; width: fit-content; }
  .tab { padding: 6px 16px; border-radius: 6px; border: none; background: none; font-size: 13px; font-weight: 500; color: var(--text2); cursor: pointer; transition: all 0.15s; }
  .tab.active { background: var(--surface); color: var(--text); box-shadow: var(--shadow); }

  .activity-item { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .activity-item:last-child { border-bottom: none; }
  .activity-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 6px; flex-shrink: 0; }
  .activity-time { font-size: 11.5px; color: var(--text3); font-family: 'DM Mono', monospace; margin-top: 2px; }
  .activity-text { font-size: 13px; }

  .search-input { padding: 7px 12px 7px 34px; border: 1px solid var(--border2); border-radius: 7px; font-size: 13.5px; background: var(--surface); outline: none; width: 240px; transition: border 0.15s; }
  .search-input:focus { border-color: var(--accent); }
  .search-wrap { position: relative; }
  .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text3); font-size: 14px; }

  .device-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
  .device-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow); transition: box-shadow 0.15s; }
  .device-card:hover { box-shadow: var(--shadow-md); }

  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
  .cal-day-label { text-align: center; font-size: 11px; font-weight: 600; color: var(--text3); text-transform: uppercase; padding: 6px 0; }
  .cal-day { min-height: 80px; padding: 6px; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); }
  .cal-day.other-month { background: var(--surface2); opacity: 0.5; }
  .cal-day.today { border-color: var(--accent); }
  .cal-day-num { font-size: 12px; font-weight: 500; margin-bottom: 4px; }
  .cal-event { font-size: 10.5px; padding: 2px 5px; border-radius: 3px; margin-bottom: 2px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

  .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .dot-green { background: var(--green); }
  .dot-red { background: var(--red); }
  .dot-yellow { background: var(--yellow); }

  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .empty-state { text-align: center; padding: 48px 20px; color: var(--text3); }
  .empty-state .empty-icon { font-size: 40px; margin-bottom: 12px; }
  .empty-state p { font-size: 13.5px; }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">üè¢</div>
    <div class="login-title">FacilityOS</div>
    <div class="login-sub">Geb√§udemanagement ¬∑ Bitte anmelden um fortzufahren</div>
    <button class="btn-google" id="btn-google-login">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
      Mit Google anmelden
    </button>
    <div class="login-hint">Nur autorisierte Google-Accounts haben Zugriff</div>
  </div>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loading-overlay">
  <div class="spinner"></div>
  <span>Daten werden geladen‚Ä¶</span>
</div>

<!-- APP -->
<div class="layout">
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-name">üè¢ FacilityOS</div>
      <div class="logo-sub">GEB√ÑUDEMANAGEMENT v2.0</div>
    </div>
    <nav style="flex:1;padding-bottom:20px;">
      <div class="nav-section">
        <div class="nav-label">√úbersicht</div>
        <button class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">üìä</span> Dashboard</button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Betrieb</div>
        <button class="nav-item" onclick="showPage('tickets')"><span class="nav-icon">üé´</span> Tickets & St√∂rungen <span class="nav-badge" id="ticket-count-badge" style="display:none">0</span></button>
        <button class="nav-item" onclick="showPage('wartung')"><span class="nav-icon">üîß</span> Wartungsauftr√§ge</button>
        <button class="nav-item" onclick="showPage('kalender')"><span class="nav-icon">üìÖ</span> Wartungskalender</button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Bestand</div>
        <button class="nav-item" onclick="showPage('geraete')"><span class="nav-icon">‚öôÔ∏è</span> Ger√§te & Anlagen</button>
        <button class="nav-item" onclick="showPage('dokumente')"><span class="nav-icon">üìÑ</span> Dokumente</button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Kontakte</div>
        <button class="nav-item" onclick="showPage('partner')"><span class="nav-icon">üè≠</span> Partnerfirmen</button>
        <button class="nav-item" onclick="showPage('notfall')"><span class="nav-icon">üö®</span> Notfallkontakte</button>
      </div>
      <div class="nav-section">
        <div class="nav-label">System</div>
        <button class="nav-item" onclick="showPage('aktivitaet')"><span class="nav-icon">üìã</span> Aktivit√§tslog</button>
      </div>
    </nav>
    <div style="padding:16px 20px;border-top:1px solid rgba(255,255,255,0.08);font-size:12px;color:rgba(255,255,255,0.3);">
      Standort: Hauptgeb√§ude<br>
      <span style="font-family:'DM Mono',monospace;" id="clock"></span>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="topbar-title" id="page-title">Dashboard</div>
      <div class="topbar-actions">
        <div class="sync-label"><span class="sync-dot" id="sync-dot" style="background:var(--yellow)"></span><span id="sync-label">Verbinde‚Ä¶</span></div>
        <div style="width:1px;height:24px;background:var(--border);margin:0 4px;"></div>
        <span class="user-name" id="user-name"></span>
        <img class="user-avatar" id="user-avatar" src="" alt="" style="display:none">
        <button class="btn-logout" id="btn-logout">Abmelden</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div class="page" id="page-dashboard">
      <div class="kpi-grid">
        <div class="kpi-card kpi-accent"><div class="kpi-label">Ger√§te gesamt</div><div class="kpi-value" id="kpi-geraete">‚Äì</div><div class="kpi-sub">in Betrieb: <span id="kpi-geraete-ok">‚Äì</span></div></div>
        <div class="kpi-card kpi-red"><div class="kpi-label">Offene Tickets</div><div class="kpi-value" id="kpi-tickets">‚Äì</div><div class="kpi-sub">davon kritisch: <span id="kpi-tickets-krit">‚Äì</span></div></div>
        <div class="kpi-card kpi-yellow"><div class="kpi-label">Wartungen (30 Tage)</div><div class="kpi-value" id="kpi-wartungen">‚Äì</div><div class="kpi-sub">f√§llig: <span id="kpi-wartungen-faellig">‚Äì</span></div></div>
        <div class="kpi-card kpi-green"><div class="kpi-label">Partnerfirmen</div><div class="kpi-value" id="kpi-partner">‚Äì</div><div class="kpi-sub">aktiv & verf√ºgbar</div></div>
      </div>
      <div class="grid-2 mb-16">
        <div class="card"><div class="card-header"><span class="card-title">‚ö†Ô∏è Kritische Tickets</span><button class="btn btn-secondary btn-sm" onclick="showPage('tickets')">Alle ansehen</button></div><div class="card-body" id="dash-tickets"><div class="empty-state"><div class="empty-icon">‚úÖ</div><p>Keine offenen Tickets</p></div></div></div>
        <div class="card"><div class="card-header"><span class="card-title">üîî Anstehende Wartungen</span><button class="btn btn-secondary btn-sm" onclick="showPage('wartung')">Alle ansehen</button></div><div class="card-body" id="dash-wartungen"><div class="empty-state"><div class="empty-icon">üìÖ</div><p>Keine anstehenden Wartungen</p></div></div></div>
      </div>
      <div class="grid-2">
        <div class="card"><div class="card-header"><span class="card-title">‚öôÔ∏è Ger√§testatus</span></div><div class="card-body" id="dash-geraete"><div class="empty-state"><div class="empty-icon">‚öôÔ∏è</div><p>Noch keine Ger√§te erfasst</p></div></div></div>
        <div class="card"><div class="card-header"><span class="card-title">üìã Letzte Aktivit√§ten</span></div><div class="card-body" id="dash-aktivitaet" style="max-height:260px;overflow-y:auto;"><div class="empty-state"><div class="empty-icon">üìã</div><p>Noch keine Aktivit√§ten</p></div></div></div>
      </div>
    </div>

    <!-- TICKETS -->
    <div class="page page-hidden" id="page-tickets">
      <div class="section-header mb-24">
        <div class="tabs">
          <button class="tab active" onclick="filterTickets('alle',this)">Alle</button>
          <button class="tab" onclick="filterTickets('offen',this)">Offen</button>
          <button class="tab" onclick="filterTickets('in_bearbeitung',this)">In Bearbeitung</button>
          <button class="tab" onclick="filterTickets('erledigt',this)">Erledigt</button>
        </div>
        <button class="btn btn-primary" onclick="openModal('modal-ticket')">+ Neues Ticket</button>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Tickets & St√∂rungsmeldungen</span><div class="search-wrap"><span class="search-icon">üîç</span><input class="search-input" placeholder="Suchen..." oninput="state.ticketSearch=this.value;renderTickets()"></div></div>
        <div class="table-wrap"><table><thead><tr><th>Betreff</th><th>Ger√§t</th><th>Priorit√§t</th><th>Status</th><th>Erstellt von</th><th>Erstellt am</th><th>Zugewiesen</th><th></th></tr></thead><tbody id="tickets-table"></tbody></table></div>
      </div>
    </div>

    <!-- WARTUNG -->
    <div class="page page-hidden" id="page-wartung">
      <div class="section-header mb-24">
        <div class="tabs">
          <button class="tab active" onclick="filterWartung('alle',this)">Alle</button>
          <button class="tab" onclick="filterWartung('geplant',this)">Geplant</button>
          <button class="tab" onclick="filterWartung('faellig',this)">F√§llig</button>
          <button class="tab" onclick="filterWartung('abgeschlossen',this)">Abgeschlossen</button>
        </div>
        <button class="btn btn-primary" onclick="openModal('modal-wartung')">+ Neuer Wartungsauftrag</button>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Wartungsauftr√§ge & Serviceauftr√§ge</span></div>
        <div class="table-wrap"><table><thead><tr><th>Bezeichnung</th><th>Ger√§t</th><th>Typ</th><th>F√§llig am</th><th>Zust√§ndig</th><th>Status</th><th></th></tr></thead><tbody id="wartung-table"></tbody></table></div>
      </div>
    </div>

    <!-- KALENDER -->
    <div class="page page-hidden" id="page-kalender">
      <div class="section-header mb-24">
        <div style="display:flex;align-items:center;gap:8px;">
          <button class="btn btn-secondary btn-sm" onclick="changeMonth(-1)">‚Üê</button>
          <select id="cal-month-select" onchange="state.calMonth=parseInt(this.value);renderCalendar()" style="border:1px solid var(--border2);border-radius:7px;padding:6px 10px;font-size:13.5px;background:var(--surface);font-family:'DM Sans',sans-serif;cursor:pointer;">
            <option value="0">Januar</option><option value="1">Februar</option><option value="2">M√§rz</option>
            <option value="3">April</option><option value="4">Mai</option><option value="5">Juni</option>
            <option value="6">Juli</option><option value="7">August</option><option value="8">September</option>
            <option value="9">Oktober</option><option value="10">November</option><option value="11">Dezember</option>
          </select>
          <select id="cal-year-select" onchange="state.calYear=parseInt(this.value);renderCalendar()" style="border:1px solid var(--border2);border-radius:7px;padding:6px 10px;font-size:13.5px;background:var(--surface);font-family:'DM Sans',sans-serif;cursor:pointer;"></select>
          <button class="btn btn-secondary btn-sm" onclick="changeMonth(1)">‚Üí</button>
        </div>
        <button class="btn btn-primary" onclick="openModal('modal-wartung')">+ Wartung planen</button>
      </div>
      <div class="card"><div class="card-body"><div class="cal-grid" id="cal-header"></div><div class="cal-grid" id="cal-body" style="margin-top:4px;"></div></div></div>
      <div class="card" style="margin-top:16px;"><div class="card-header"><span class="card-title">Ereignisse dieses Monats</span></div><div class="table-wrap"><table><thead><tr><th>Datum</th><th>Bezeichnung</th><th>Ger√§t</th><th>Typ</th><th>Status</th></tr></thead><tbody id="cal-events-list"></tbody></table></div></div>
    </div>

    <!-- GER√ÑTE -->
    <div class="page page-hidden" id="page-geraete">
      <div class="section-header mb-24">
        <div class="tabs">
          <button class="tab active" onclick="filterGeraete('alle',this)">Alle</button>
          <button class="tab" onclick="filterGeraete('aktiv',this)">Aktiv</button>
          <button class="tab" onclick="filterGeraete('stoerung',this)">St√∂rung</button>
        </div>
        <button class="btn btn-primary" onclick="openModal('modal-geraet')">+ Ger√§t hinzuf√ºgen</button>
      </div>
      <div class="device-grid" id="geraete-grid"><div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">‚öôÔ∏è</div><p>Noch keine Ger√§te erfasst</p></div></div>
    </div>

    <!-- DOKUMENTE -->
    <div class="page page-hidden" id="page-dokumente">
      <div class="section-header mb-24"><span></span><button class="btn btn-primary" onclick="openModal('modal-dokument')">+ Dokument erfassen</button></div>
      <div class="card"><div class="card-header"><span class="card-title">Dokumente & Handb√ºcher</span></div><div class="table-wrap"><table><thead><tr><th>Bezeichnung</th><th>Typ</th><th>Ger√§t</th><th>Datum</th><th>Notiz</th><th></th></tr></thead><tbody id="dokumente-table"></tbody></table></div></div>
    </div>

    <!-- PARTNER -->
    <div class="page page-hidden" id="page-partner">
      <div class="section-header mb-24"><span></span><button class="btn btn-primary" onclick="openModal('modal-partner')">+ Partnerfirma hinzuf√ºgen</button></div>
      <div id="partner-grid" class="grid-3"></div>
    </div>

    <!-- NOTFALL -->
    <div class="page page-hidden" id="page-notfall">
      <div class="section-header mb-24">
        <div style="background:var(--red-light);border:1px solid #fca5a5;border-radius:8px;padding:10px 16px;font-size:13px;color:var(--red);">üö® Notfallkontakte ‚Äì nur bei echten Notf√§llen kontaktieren</div>
        <button class="btn btn-primary" onclick="openModal('modal-notfall')">+ Kontakt hinzuf√ºgen</button>
      </div>
      <div id="notfall-grid" class="grid-3"></div>
    </div>

    <!-- LOG -->
    <div class="page page-hidden" id="page-aktivitaet">
      <div class="card"><div class="card-header"><span class="card-title">Vollst√§ndiger Aktivit√§tslog</span><span style="font-size:11.5px;color:var(--text3);" id="log-count"></span></div><div class="card-body" id="aktivitaet-full" style="max-height:600px;overflow-y:auto;"></div></div>
    </div>
  </main>
</div>

<!-- MODALS -->
<div class="modal-overlay hidden" id="modal-ticket">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">Neues Ticket / St√∂rungsmeldung</span><button class="modal-close" onclick="closeModal('modal-ticket')">√ó</button></div>
    <div class="modal-body">
      <div class="grid-2"><div class="form-group"><label class="form-label">Betreff *</label><input class="form-input" id="t-betreff" placeholder="Kurze Beschreibung"></div><div class="form-group"><label class="form-label">Priorit√§t *</label><select class="form-select" id="t-prioritaet"><option value="kritisch">üî¥ Kritisch</option><option value="hoch">üü† Hoch</option><option value="mittel" selected>üü° Mittel</option><option value="niedrig">üü¢ Niedrig</option></select></div></div>
      <div class="grid-2"><div class="form-group"><label class="form-label">Ger√§t / Bereich</label><select class="form-select" id="t-geraet"><option value="">‚Äì ausw√§hlen ‚Äì</option></select></div><div class="form-group"><label class="form-label">Zugewiesen an</label><select class="form-select" id="t-partner"><option value="">‚Äì ausw√§hlen ‚Äì</option></select></div></div>
      <div class="form-group"><label class="form-label">Beschreibung</label><textarea class="form-textarea" id="t-beschreibung" placeholder="Detaillierte Beschreibung..."></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-ticket')">Abbrechen</button><button class="btn btn-primary" id="btn-save-ticket">Ticket erstellen</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="modal-wartung">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">Wartungsauftrag erfassen</span><button class="modal-close" onclick="closeModal('modal-wartung')">√ó</button></div>
    <div class="modal-body">
      <div class="grid-2"><div class="form-group"><label class="form-label">Bezeichnung *</label><input class="form-input" id="w-bezeichnung"></div><div class="form-group"><label class="form-label">Typ</label><select class="form-select" id="w-typ"><option value="inspektion">Inspektion</option><option value="wartung">Wartung</option><option value="reparatur">Reparatur</option><option value="pruefung">Pr√ºfung/T√úV</option><option value="service">Serviceauftrag</option></select></div></div>
      <div class="grid-2"><div class="form-group"><label class="form-label">Ger√§t / Anlage</label><select class="form-select" id="w-geraet"><option value="">‚Äì ausw√§hlen ‚Äì</option></select></div><div class="form-group"><label class="form-label">Zust√§ndige Firma</label><select class="form-select" id="w-partner"><option value="">‚Äì ausw√§hlen ‚Äì</option></select></div></div>
      <div class="grid-2"><div class="form-group"><label class="form-label">F√§lligkeitsdatum *</label><input class="form-input" type="date" id="w-datum"></div><div class="form-group"><label class="form-label">Wiederholung</label><select class="form-select" id="w-intervall"><option value="einmalig">Einmalig</option><option value="monatlich">Monatlich</option><option value="quartalsweise">Quartalsweise</option><option value="halbjaehrlich">Halbj√§hrlich</option><option value="jaehrlich">J√§hrlich</option></select></div></div>
      <div class="form-group"><label class="form-label">Notizen</label><textarea class="form-textarea" id="w-notizen"></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-wartung')">Abbrechen</button><button class="btn btn-primary" id="btn-save-wartung">Auftrag erstellen</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="modal-geraet">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">Ger√§t / Anlage hinzuf√ºgen</span><button class="modal-close" onclick="closeModal('modal-geraet')">√ó</button></div>
    <div class="modal-body">
      <div class="grid-2"><div class="form-group"><label class="form-label">Bezeichnung *</label><input class="form-input" id="g-name"></div><div class="form-group"><label class="form-label">Kategorie *</label><select class="form-select" id="g-kategorie"><option value="aufzug">üõó Aufzug</option><option value="heizung">üî• Heizung/HVAC</option><option value="klima">‚ùÑÔ∏è Klimaanlage</option><option value="elektro">‚ö° Elektro/USV</option><option value="brandschutz">üßØ Brandschutz</option><option value="sicherheit">üîí Sicherheitssystem</option><option value="sanitaer">üöø Sanit√§r</option><option value="kueche">üç≥ K√ºchenger√§te</option><option value="it">üíª IT-Infrastruktur</option><option value="solar">‚òÄÔ∏è Solar/PV</option><option value="sonstiges">üîß Sonstiges</option></select></div></div>
      <div class="grid-2"><div class="form-group"><label class="form-label">Hersteller</label><input class="form-input" id="g-hersteller"></div><div class="form-group"><label class="form-label">Seriennummer</label><input class="form-input" id="g-seriennummer"></div></div>
      <div class="grid-2"><div class="form-group"><label class="form-label">Installationsdatum</label><input class="form-input" type="date" id="g-baujahr"></div><div class="form-group"><label class="form-label">Standort / Raum</label><input class="form-input" id="g-standort"></div></div>
      <div class="grid-2"><div class="form-group"><label class="form-label">N√§chste Wartung</label><input class="form-input" type="date" id="g-naechste-wartung"></div><div class="form-group"><label class="form-label">Zust√§ndige Partnerfirma</label><select class="form-select" id="g-partner"><option value="">‚Äì ausw√§hlen ‚Äì</option></select></div></div>
      <div class="form-group"><label class="form-label">Notizen</label><textarea class="form-textarea" id="g-notizen"></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-geraet')">Abbrechen</button><button class="btn btn-primary" id="btn-save-geraet">Ger√§t speichern</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="modal-partner">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">Partnerfirma hinzuf√ºgen</span><button class="modal-close" onclick="closeModal('modal-partner')">√ó</button></div>
    <div class="modal-body">
      <div class="grid-2"><div class="form-group"><label class="form-label">Firmenname *</label><input class="form-input" id="p-name"></div><div class="form-group"><label class="form-label">Fachbereich</label><select class="form-select" id="p-bereich"><option>Aufzugstechnik</option><option>Heizung & Sanit√§r</option><option>Elektrotechnik</option><option>Klimatechnik</option><option>Brandschutz</option><option>Sicherheitstechnik</option><option>IT & Netzwerk</option><option>Allgemeiner Geb√§udeservice</option><option>Sonstiges</option></select></div></div>
      <div class="grid-2"><div class="form-group"><label class="form-label">Ansprechpartner</label><input class="form-input" id="p-kontakt"></div><div class="form-group"><label class="form-label">Telefon</label><input class="form-input" id="p-telefon"></div></div>
      <div class="grid-2"><div class="form-group"><label class="form-label">E-Mail</label><input class="form-input" id="p-email" type="email"></div><div class="form-group"><label class="form-label">Vertragsnummer</label><input class="form-input" id="p-vertrag"></div></div>
      <div class="form-group"><label class="form-label">Adresse</label><input class="form-input" id="p-adresse"></div>
      <div class="form-group"><label class="form-label">Notizen</label><textarea class="form-textarea" id="p-notizen"></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-partner')">Abbrechen</button><button class="btn btn-primary" id="btn-save-partner">Firma speichern</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="modal-notfall">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">Notfallkontakt hinzuf√ºgen</span><button class="modal-close" onclick="closeModal('modal-notfall')">√ó</button></div>
    <div class="modal-body">
      <div class="grid-2"><div class="form-group"><label class="form-label">Name / Funktion *</label><input class="form-input" id="n-name"></div><div class="form-group"><label class="form-label">Kategorie</label><select class="form-select" id="n-kategorie"><option>Intern</option><option>Feuerwehr / Rettung</option><option>Polizei</option><option>Aufzugnotdienst</option><option>Heizungsnotdienst</option><option>Elektronotdienst</option><option>Wassernotdienst</option><option>Facility Management</option><option>Sonstiges</option></select></div></div>
      <div class="grid-2"><div class="form-group"><label class="form-label">Telefon *</label><input class="form-input" id="n-telefon"></div><div class="form-group"><label class="form-label">Erreichbar</label><select class="form-select" id="n-erreichbar"><option value="24/7">24/7</option><option value="werktags">Werktags</option><option value="auf-abruf">Auf Abruf</option></select></div></div>
      <div class="form-group"><label class="form-label">Notizen</label><textarea class="form-textarea" id="n-notizen"></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-notfall')">Abbrechen</button><button class="btn btn-primary" id="btn-save-notfall">Kontakt speichern</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="modal-dokument">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">Dokument erfassen</span><button class="modal-close" onclick="closeModal('modal-dokument')">√ó</button></div>
    <div class="modal-body">
      <div class="grid-2"><div class="form-group"><label class="form-label">Bezeichnung *</label><input class="form-input" id="d-name"></div><div class="form-group"><label class="form-label">Dokumenttyp</label><select class="form-select" id="d-typ"><option>Betriebsanleitung</option><option>Wartungsprotokoll</option><option>Pr√ºfbericht / T√úV</option><option>Schaltplan</option><option>Garantieurkunde</option><option>Vertrag</option><option>Zertifikat</option><option>Sonstiges</option></select></div></div>
      <div class="grid-2"><div class="form-group"><label class="form-label">Ger√§t / Anlage</label><select class="form-select" id="d-geraet"><option value="">‚Äì ausw√§hlen ‚Äì</option></select></div><div class="form-group"><label class="form-label">Datum</label><input class="form-input" type="date" id="d-datum"></div></div>
      <div class="form-group"><label class="form-label">Notiz</label><textarea class="form-textarea" id="d-notiz"></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-dokument')">Abbrechen</button><button class="btn btn-primary" id="btn-save-dokument">Speichern</button></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut as fbSignOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDcfrW2Q7Q61oqZFCo9D-CcLKpQYhiIkwM",
  authDomain: "facility-manager-c4e2a.firebaseapp.com",
  projectId: "facility-manager-c4e2a",
  storageBucket: "facility-manager-c4e2a.firebasestorage.app",
  messagingSenderId: "604174388916",
  appId: "1:604174388916:web:c8193668c30453691cd1e1"
};

const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);
const auth = getAuth(fbApp);
const provider = new GoogleAuthProvider();

let currentUser = null;

// Auth
document.getElementById('btn-google-login').onclick = () => signInWithPopup(auth, provider).catch(e => alert('Anmeldung fehlgeschlagen: ' + e.message));
document.getElementById('btn-logout').onclick = () => fbSignOut(auth);

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('user-name').textContent = user.displayName || user.email;
    if (user.photoURL) { const av = document.getElementById('user-avatar'); av.src = user.photoURL; av.style.display = ''; }
    startListeners();
  } else {
    currentUser = null;
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('loading-overlay').classList.add('hidden');
  }
});

// Firestore
function col(name) { return query(collection(db, name), orderBy('createdAt', 'desc')); }

let loadedCount = 0;
function checkLoaded() { loadedCount++; if (loadedCount >= 7) document.getElementById('loading-overlay').classList.add('hidden'); }

function startListeners() {
  loadedCount = 0;
  document.getElementById('loading-overlay').classList.remove('hidden');

  onSnapshot(col('tickets'), s => { window.state.tickets = s.docs.map(d=>({id:d.id,...d.data()})); renderAll(); checkLoaded(); }, ()=>checkLoaded());
  onSnapshot(col('wartungen'), s => { window.state.wartungen = s.docs.map(d=>({id:d.id,...d.data()})); renderAll(); if(!document.getElementById('page-kalender').classList.contains('page-hidden')) renderCalendar(); checkLoaded(); }, ()=>checkLoaded());
  onSnapshot(col('geraete'), s => { window.state.geraete = s.docs.map(d=>({id:d.id,...d.data()})); renderAll(); checkLoaded(); }, ()=>checkLoaded());
  onSnapshot(col('partner'), s => { window.state.partner = s.docs.map(d=>({id:d.id,...d.data()})); renderAll(); checkLoaded(); }, ()=>checkLoaded());
  onSnapshot(col('notfaelle'), s => { window.state.notfaelle = s.docs.map(d=>({id:d.id,...d.data()})); renderAll(); checkLoaded(); }, ()=>checkLoaded());
  onSnapshot(col('dokumente'), s => { window.state.dokumente = s.docs.map(d=>({id:d.id,...d.data()})); renderAll(); checkLoaded(); }, ()=>checkLoaded());
  onSnapshot(col('log'), s => { window.state.log = s.docs.map(d=>({id:d.id,...d.data()})); renderAll(); checkLoaded(); }, ()=>checkLoaded());

  document.getElementById('sync-dot').style.background = 'var(--green)';
  document.getElementById('sync-label').textContent = 'Live-Sync aktiv';
}

async function addLog(text, color='#2563eb') {
  await addDoc(collection(db,'log'), { text, color, user: currentUser?.displayName||currentUser?.email||'', createdAt: serverTimestamp() });
}

// SAVE buttons wired here (module scope)
document.getElementById('btn-save-ticket').onclick = async () => {
  const betreff = document.getElementById('t-betreff').value.trim();
  if (!betreff) { alert('Bitte einen Betreff eingeben.'); return; }
  const gId = document.getElementById('t-geraet').value;
  const pId = document.getElementById('t-partner').value;
  const data = {
    betreff, prioritaet: document.getElementById('t-prioritaet').value,
    geraetId: gId, geraetName: window.state.geraete.find(g=>g.id===gId)?.name||'',
    partnerId: pId, partnerName: window.state.partner.find(p=>p.id===pId)?.name||'',
    beschreibung: document.getElementById('t-beschreibung').value,
  };
  if(window._editId && window._editType==='tickets'){
    await updateDoc(doc(db,'tickets',window._editId), data);
    await addLog(`Ticket "${betreff}" bearbeitet`, '#2563eb');
  } else {
    data.ersteller = currentUser?.displayName||currentUser?.email||'';
    data.status = 'offen'; data.createdAt = serverTimestamp();
    await addDoc(collection(db,'tickets'), data);
    await addLog(`Ticket erstellt: "${betreff}" (${currentUser?.displayName||''})`, '#dc2626');
  }
  closeModal('modal-ticket');
};

document.getElementById('btn-save-wartung').onclick = async () => {
  const bez = document.getElementById('w-bezeichnung').value.trim();
  const datum = document.getElementById('w-datum').value;
  if (!bez||!datum) { alert('Bitte Bezeichnung und Datum ausf√ºllen.'); return; }
  const gId = document.getElementById('w-geraet').value;
  const pId = document.getElementById('w-partner').value;
  const data = {
    bezeichnung: bez, typ: document.getElementById('w-typ').value,
    geraetId: gId, geraetName: window.state.geraete.find(g=>g.id===gId)?.name||'',
    partnerId: pId, partnerName: window.state.partner.find(p=>p.id===pId)?.name||'',
    datum, intervall: document.getElementById('w-intervall').value,
    notizen: document.getElementById('w-notizen').value,
    status: new Date(datum) < new Date() ? 'faellig' : 'geplant',
  };
  if(window._editId && window._editType==='wartungen'){
    await updateDoc(doc(db,'wartungen',window._editId), data);
    await addLog(`Wartung "${bez}" bearbeitet`, '#d97706');
  } else {
    data.createdAt = serverTimestamp();
    await addDoc(collection(db,'wartungen'), data);
    await addLog(`Wartung erstellt: "${bez}" am ${datum}`, '#d97706');
  }
  closeModal('modal-wartung');
};

document.getElementById('btn-save-geraet').onclick = async () => {
  const name = document.getElementById('g-name').value.trim();
  if (!name) { alert('Bitte eine Bezeichnung eingeben.'); return; }
  const pId = document.getElementById('g-partner').value;
  const data = {
    name, kategorie: document.getElementById('g-kategorie').value,
    hersteller: document.getElementById('g-hersteller').value,
    seriennummer: document.getElementById('g-seriennummer').value,
    baujahr: document.getElementById('g-baujahr').value,
    standort: document.getElementById('g-standort').value,
    naechsteWartung: document.getElementById('g-naechste-wartung').value,
    partnerId: pId, partnerName: window.state.partner.find(p=>p.id===pId)?.name||'',
    notizen: document.getElementById('g-notizen').value,
  };
  if(window._editId && window._editType==='geraete'){
    await updateDoc(doc(db,'geraete',window._editId), data);
    await addLog(`Ger√§t "${name}" bearbeitet`, '#16a34a');
  } else {
    data.status = 'aktiv'; data.createdAt = serverTimestamp();
    await addDoc(collection(db,'geraete'), data);
    await addLog(`Ger√§t "${name}" hinzugef√ºgt`, '#16a34a');
  }
  closeModal('modal-geraet');
};

document.getElementById('btn-save-partner').onclick = async () => {
  const name = document.getElementById('p-name').value.trim();
  if (!name) { alert('Firmennamen eingeben.'); return; }
  const data = {
    name, bereich: document.getElementById('p-bereich').value,
    kontakt: document.getElementById('p-kontakt').value,
    telefon: document.getElementById('p-telefon').value,
    email: document.getElementById('p-email').value,
    vertrag: document.getElementById('p-vertrag').value,
    adresse: document.getElementById('p-adresse').value,
    notizen: document.getElementById('p-notizen').value,
  };
  if(window._editId && window._editType==='partner'){
    await updateDoc(doc(db,'partner',window._editId), data);
    await addLog(`Partnerfirma "${name}" bearbeitet`, '#2563eb');
  } else {
    data.createdAt = serverTimestamp();
    await addDoc(collection(db,'partner'), data);
    await addLog(`Partnerfirma "${name}" hinzugef√ºgt`, '#2563eb');
  }
  closeModal('modal-partner');
};

document.getElementById('btn-save-notfall').onclick = async () => {
  const name = document.getElementById('n-name').value.trim();
  const telefon = document.getElementById('n-telefon').value.trim();
  if (!name||!telefon) { alert('Name und Telefon ausf√ºllen.'); return; }
  const data = {
    name, kategorie: document.getElementById('n-kategorie').value,
    telefon, erreichbar: document.getElementById('n-erreichbar').value,
    notizen: document.getElementById('n-notizen').value,
  };
  if(window._editId && window._editType==='notfaelle'){
    await updateDoc(doc(db,'notfaelle',window._editId), data);
    await addLog(`Notfallkontakt "${name}" bearbeitet`, '#dc2626');
  } else {
    data.createdAt = serverTimestamp();
    await addDoc(collection(db,'notfaelle'), data);
    await addLog(`Notfallkontakt "${name}" hinzugef√ºgt`, '#dc2626');
  }
  closeModal('modal-notfall');
};

document.getElementById('btn-save-dokument').onclick = async () => {
  const name = document.getElementById('d-name').value.trim();
  if (!name) { alert('Bezeichnung eingeben.'); return; }
  const gId = document.getElementById('d-geraet').value;
  const data = {
    name, typ: document.getElementById('d-typ').value,
    geraetId: gId, geraetName: window.state.geraete.find(g=>g.id===gId)?.name||'',
    datum: document.getElementById('d-datum').value,
    notiz: document.getElementById('d-notiz').value,
  };
  if(window._editId && window._editType==='dokumente'){
    await updateDoc(doc(db,'dokumente',window._editId), data);
    await addLog(`Dokument "${name}" bearbeitet`, '#5a5850');
  } else {
    data.createdAt = serverTimestamp();
    await addDoc(collection(db,'dokumente'), data);
    await addLog(`Dokument "${name}" erfasst`, '#5a5850');
  }
  closeModal('modal-dokument');
};

// Update / Delete exposed globally
window.updateTicketStatus = async (id, status) => {
  await updateDoc(doc(db,'tickets',id), {status});
  const t = window.state.tickets.find(t=>t.id===id);
  await addLog(`Ticket "${t?.betreff||id}" ‚Üí ${status} (${currentUser?.displayName||''})`, '#2563eb');
};
window.updateWartungStatus = async (id, status) => {
  await updateDoc(doc(db,'wartungen',id), {status});
  await addLog(`Wartung "${window.state.wartungen.find(w=>w.id===id)?.bezeichnung||id}" ‚Üí ${status}`, '#d97706');
};
window.changeGeraetStatus = async (id, status) => {
  await updateDoc(doc(db,'geraete',id), {status});
  await addLog(`Ger√§t "${window.state.geraete.find(g=>g.id===id)?.name||id}" ‚Üí ${status}`, '#16a34a');
};
window.deleteItem = async (col, id) => {
  if (!confirm('Wirklich l√∂schen?')) return;
  await deleteDoc(doc(db,col,id));
  await addLog(`Eintrag gel√∂scht (${col})`, '#9a9890');
};

// ---- EDIT ----
window.editItem = (type, id) => {
  const item = window.state[type].find(i=>i.id===id);
  if(!item) return;
  window._editId = id;
  window._editType = type;
  populateSelects();

  if(type==='tickets'){
    document.getElementById('t-betreff').value=item.betreff||'';
    document.getElementById('t-prioritaet').value=item.prioritaet||'mittel';
    document.getElementById('t-geraet').value=item.geraetId||'';
    document.getElementById('t-partner').value=item.partnerId||'';
    document.getElementById('t-beschreibung').value=item.beschreibung||'';
    document.getElementById('modal-ticket').querySelector('.modal-title').textContent='Ticket bearbeiten';
    document.getElementById('btn-save-ticket').textContent='√Ñnderungen speichern';
    document.getElementById('modal-ticket').classList.remove('hidden');
  } else if(type==='wartungen'){
    document.getElementById('w-bezeichnung').value=item.bezeichnung||'';
    document.getElementById('w-typ').value=item.typ||'wartung';
    document.getElementById('w-geraet').value=item.geraetId||'';
    document.getElementById('w-partner').value=item.partnerId||'';
    document.getElementById('w-datum').value=item.datum||'';
    document.getElementById('w-intervall').value=item.intervall||'einmalig';
    document.getElementById('w-notizen').value=item.notizen||'';
    document.getElementById('modal-wartung').querySelector('.modal-title').textContent='Wartungsauftrag bearbeiten';
    document.getElementById('btn-save-wartung').textContent='√Ñnderungen speichern';
    document.getElementById('modal-wartung').classList.remove('hidden');
  } else if(type==='geraete'){
    document.getElementById('g-name').value=item.name||'';
    document.getElementById('g-kategorie').value=item.kategorie||'sonstiges';
    document.getElementById('g-hersteller').value=item.hersteller||'';
    document.getElementById('g-seriennummer').value=item.seriennummer||'';
    document.getElementById('g-baujahr').value=item.baujahr||'';
    document.getElementById('g-standort').value=item.standort||'';
    document.getElementById('g-naechste-wartung').value=item.naechsteWartung||'';
    document.getElementById('g-partner').value=item.partnerId||'';
    document.getElementById('g-notizen').value=item.notizen||'';
    document.getElementById('modal-geraet').querySelector('.modal-title').textContent='Ger√§t bearbeiten';
    document.getElementById('btn-save-geraet').textContent='√Ñnderungen speichern';
    document.getElementById('modal-geraet').classList.remove('hidden');
  } else if(type==='partner'){
    document.getElementById('p-name').value=item.name||'';
    document.getElementById('p-bereich').value=item.bereich||'';
    document.getElementById('p-kontakt').value=item.kontakt||'';
    document.getElementById('p-telefon').value=item.telefon||'';
    document.getElementById('p-email').value=item.email||'';
    document.getElementById('p-vertrag').value=item.vertrag||'';
    document.getElementById('p-adresse').value=item.adresse||'';
    document.getElementById('p-notizen').value=item.notizen||'';
    document.getElementById('modal-partner').querySelector('.modal-title').textContent='Partnerfirma bearbeiten';
    document.getElementById('btn-save-partner').textContent='√Ñnderungen speichern';
    document.getElementById('modal-partner').classList.remove('hidden');
  } else if(type==='notfaelle'){
    document.getElementById('n-name').value=item.name||'';
    document.getElementById('n-kategorie').value=item.kategorie||'';
    document.getElementById('n-telefon').value=item.telefon||'';
    document.getElementById('n-erreichbar').value=item.erreichbar||'24/7';
    document.getElementById('n-notizen').value=item.notizen||'';
    document.getElementById('modal-notfall').querySelector('.modal-title').textContent='Notfallkontakt bearbeiten';
    document.getElementById('btn-save-notfall').textContent='√Ñnderungen speichern';
    document.getElementById('modal-notfall').classList.remove('hidden');
  } else if(type==='dokumente'){
    document.getElementById('d-name').value=item.name||'';
    document.getElementById('d-typ').value=item.typ||'';
    document.getElementById('d-geraet').value=item.geraetId||'';
    document.getElementById('d-datum').value=item.datum||'';
    document.getElementById('d-notiz').value=item.notiz||'';
    document.getElementById('modal-dokument').querySelector('.modal-title').textContent='Dokument bearbeiten';
    document.getElementById('btn-save-dokument').textContent='√Ñnderungen speichern';
    document.getElementById('modal-dokument').classList.remove('hidden');
  }
};
</script>

<script>
window.state = { tickets:[], wartungen:[], geraete:[], partner:[], notfaelle:[], dokumente:[], log:[], ticketFilter:'alle', wartungFilter:'alle', geraeteFilter:'alle', calMonth:new Date().getMonth(), calYear:new Date().getFullYear(), ticketSearch:'' };

function showPage(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.add('page-hidden'));
  document.getElementById('page-'+name).classList.remove('page-hidden');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>{ if(n.getAttribute('onclick')===`showPage('${name}')`) n.classList.add('active'); });
  const titles={dashboard:'Dashboard',tickets:'Tickets & St√∂rungen',wartung:'Wartungsauftr√§ge',kalender:'Wartungskalender',geraete:'Ger√§te & Anlagen',dokumente:'Dokumente',partner:'Partnerfirmen',notfall:'Notfallkontakte',aktivitaet:'Aktivit√§tslog'};
  document.getElementById('page-title').textContent = titles[name]||name;
  if(name==='kalender') renderCalendar();
  if(name==='aktivitaet') renderAktivitaet();
}

function openModal(id) { populateSelects(); document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) {
  document.getElementById(id).classList.add('hidden');
  document.querySelectorAll(`#${id} input,#${id} textarea`).forEach(e=>e.value='');
  document.querySelectorAll(`#${id} select`).forEach(e=>e.selectedIndex=0);
  window._editId=null; window._editType=null;
  // Reset titles and button labels
  const titleMap={'modal-ticket':'Neues Ticket / St√∂rungsmeldung','modal-wartung':'Wartungsauftrag erfassen','modal-geraet':'Ger√§t / Anlage hinzuf√ºgen','modal-partner':'Partnerfirma hinzuf√ºgen','modal-notfall':'Notfallkontakt hinzuf√ºgen','modal-dokument':'Dokument erfassen'};
  const btnMap={'modal-ticket':'btn-save-ticket','modal-wartung':'btn-save-wartung','modal-geraet':'btn-save-geraet','modal-partner':'btn-save-partner','modal-notfall':'btn-save-notfall','modal-dokument':'btn-save-dokument'};
  const saveLabelMap={'modal-ticket':'Ticket erstellen','modal-wartung':'Auftrag erstellen','modal-geraet':'Ger√§t speichern','modal-partner':'Firma speichern','modal-notfall':'Kontakt speichern','modal-dokument':'Speichern'};
  if(titleMap[id]) document.querySelector(`#${id} .modal-title`).textContent=titleMap[id];
  if(btnMap[id]) document.getElementById(btnMap[id]).textContent=saveLabelMap[id];
}

function populateSelects() {
  const g = state.geraete.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
  const p = state.partner.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  ['t-geraet','w-geraet','d-geraet'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML='<option value="">‚Äì ausw√§hlen ‚Äì</option>'+g;});
  ['t-partner','w-partner'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML='<option value="">‚Äì ausw√§hlen ‚Äì</option>'+p;});
  const gp=document.getElementById('g-partner');if(gp)gp.innerHTML='<option value="">‚Äì ausw√§hlen ‚Äì</option>'+p;
}

const pBadge={kritisch:'badge-red',hoch:'badge-orange',mittel:'badge-yellow',niedrig:'badge-green'};
const pLabel={kritisch:'üî¥ Kritisch',hoch:'üü† Hoch',mittel:'üü° Mittel',niedrig:'üü¢ Niedrig'};
const sBadge={offen:'badge-red',in_bearbeitung:'badge-yellow',erledigt:'badge-green',geplant:'badge-blue',faellig:'badge-orange',abgeschlossen:'badge-green'};
const sLabel={offen:'Offen',in_bearbeitung:'In Bearbeitung',erledigt:'Erledigt',geplant:'Geplant',faellig:'F√§llig',abgeschlossen:'Abgeschlossen'};
const kIcons={aufzug:'üõó',heizung:'üî•',klima:'‚ùÑÔ∏è',elektro:'‚ö°',brandschutz:'üßØ',sicherheit:'üîí',sanitaer:'üöø',kueche:'üç≥',it:'üíª',solar:'‚òÄÔ∏è',sonstiges:'üîß'};

function fDate(d){if(!d)return'‚Äì';try{return new Date(d+'T00:00:00').toLocaleDateString('de-DE');}catch(e){return d;}}
function fTs(ts){if(!ts)return'‚Äì';try{const d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleDateString('de-DE')+' '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});}catch(e){return'‚Äì';}}

function renderAll() { renderDashboard();renderTickets();renderWartungen();renderGeraete();renderPartner();renderNotfall();renderDokumente();updateBadges(); }

function renderDashboard() {
  const offene=state.tickets.filter(t=>t.status!=='erledigt');
  const now=new Date(),in30=new Date();in30.setDate(in30.getDate()+30);
  const w30=state.wartungen.filter(w=>{const d=new Date(w.datum);return d>=now&&d<=in30;});
  const faellig=state.wartungen.filter(w=>w.status==='faellig'||(new Date(w.datum)<now&&w.status!=='abgeschlossen'));
  document.getElementById('kpi-geraete').textContent=state.geraete.length;
  document.getElementById('kpi-geraete-ok').textContent=state.geraete.filter(g=>g.status==='aktiv').length;
  document.getElementById('kpi-tickets').textContent=offene.length;
  document.getElementById('kpi-tickets-krit').textContent=offene.filter(t=>t.prioritaet==='kritisch').length;
  document.getElementById('kpi-wartungen').textContent=w30.length;
  document.getElementById('kpi-wartungen-faellig').textContent=faellig.length;
  document.getElementById('kpi-partner').textContent=state.partner.length;
  const dt=document.getElementById('dash-tickets'),ct=state.tickets.filter(t=>t.status!=='erledigt'&&(t.prioritaet==='kritisch'||t.prioritaet==='hoch')).slice(0,5);
  dt.innerHTML=ct.length?ct.map(t=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);"><span class="badge ${pBadge[t.prioritaet]}">${pLabel[t.prioritaet]}</span><span style="flex:1;font-size:13px;">${t.betreff}</span><span class="badge ${sBadge[t.status]}">${sLabel[t.status]}</span></div>`).join(''):'<div class="empty-state"><div class="empty-icon">‚úÖ</div><p>Keine kritischen Tickets</p></div>';
  const dw=document.getElementById('dash-wartungen'),up=[...state.wartungen].filter(w=>w.status!=='abgeschlossen').sort((a,b)=>new Date(a.datum)-new Date(b.datum)).slice(0,5);
  dw.innerHTML=up.length?up.map(w=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);"><span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--text3);min-width:80px;">${fDate(w.datum)}</span><span style="flex:1;font-size:13px;">${w.bezeichnung}</span><span class="badge ${sBadge[w.status]}">${sLabel[w.status]}</span></div>`).join(''):'<div class="empty-state"><div class="empty-icon">üìÖ</div><p>Keine anstehenden Wartungen</p></div>';
  const dg=document.getElementById('dash-geraete');
  dg.innerHTML=state.geraete.length?`<div style="display:flex;flex-direction:column;gap:8px;">${state.geraete.slice(0,6).map(g=>`<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--border);"><span>${kIcons[g.kategorie]||'üîß'}</span><span style="flex:1;font-size:13px;font-weight:500;">${g.name}</span>${g.naechsteWartung?`<span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);">${fDate(g.naechsteWartung)}</span>`:''}<span class="status-dot dot-${g.status==='aktiv'?'green':g.status==='stoerung'?'red':'yellow'}"></span></div>`).join('')}</div>`:'<div class="empty-state"><div class="empty-icon">‚öôÔ∏è</div><p>Noch keine Ger√§te erfasst</p></div>';
  const da=document.getElementById('dash-aktivitaet');
  da.innerHTML=state.log.length?state.log.slice(0,8).map(l=>`<div class="activity-item"><div class="activity-dot" style="background:${l.color}"></div><div><div class="activity-text">${l.text}</div><div class="activity-time">${fTs(l.createdAt)}${l.user?' ¬∑ '+l.user:''}</div></div></div>`).join(''):'<div class="empty-state"><div class="empty-icon">üìã</div><p>Noch keine Aktivit√§ten</p></div>';
}

function renderTickets() {
  let data=state.tickets;
  if(state.ticketFilter!=='alle') data=data.filter(t=>t.status===state.ticketFilter);
  if(state.ticketSearch) data=data.filter(t=>t.betreff.toLowerCase().includes(state.ticketSearch.toLowerCase()));
  const tb=document.getElementById('tickets-table');
  tb.innerHTML=data.length?data.map(t=>`<tr><td><span style="font-weight:500;">${t.betreff}</span>${t.beschreibung?`<div style="font-size:12px;color:var(--text3);">${t.beschreibung.substring(0,60)}${t.beschreibung.length>60?'...':''}</div>`:''}</td><td>${t.geraetName||'‚Äì'}</td><td><span class="badge ${pBadge[t.prioritaet]}">${pLabel[t.prioritaet]}</span></td><td><select onchange="updateTicketStatus('${t.id}',this.value)" style="border:1px solid var(--border2);border-radius:5px;padding:3px 8px;font-size:12px;background:var(--surface);"><option value="offen" ${t.status==='offen'?'selected':''}>Offen</option><option value="in_bearbeitung" ${t.status==='in_bearbeitung'?'selected':''}>In Bearbeitung</option><option value="erledigt" ${t.status==='erledigt'?'selected':''}>Erledigt</option></select></td><td style="font-size:12px;color:var(--text3);">${t.ersteller||'‚Äì'}</td><td style="font-family:'DM Mono',monospace;font-size:11px;">${fTs(t.createdAt)}</td><td>${t.partnerName||'‚Äì'}</td><td style="white-space:nowrap;"><button class="btn btn-sm btn-edit" onclick="editItem('tickets','${t.id}')">‚úèÔ∏è</button> <button class="btn btn-secondary btn-sm" onclick="deleteItem('tickets','${t.id}')">üóëÔ∏è</button></td></tr>`).join(''):`<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">üé´</div><p>Keine Tickets gefunden</p></div></td></tr>`;
}

function renderWartungen() {
  let data=[...state.wartungen];
  if(state.wartungFilter==='faellig') data=data.filter(w=>w.status==='faellig'||(new Date(w.datum)<new Date()&&w.status!=='abgeschlossen'));
  else if(state.wartungFilter!=='alle') data=data.filter(w=>w.status===state.wartungFilter);
  data.sort((a,b)=>new Date(a.datum)-new Date(b.datum));
  const tb=document.getElementById('wartung-table');
  tb.innerHTML=data.length?data.map(w=>`<tr><td><span style="font-weight:500;">${w.bezeichnung}</span></td><td>${w.geraetName||'‚Äì'}</td><td><span class="badge badge-gray">${w.typ}</span></td><td style="font-family:'DM Mono',monospace;font-size:12px;${new Date(w.datum)<new Date()&&w.status!=='abgeschlossen'?'color:var(--red);font-weight:600;':''}">${fDate(w.datum)}</td><td>${w.partnerName||'‚Äì'}</td><td><select onchange="updateWartungStatus('${w.id}',this.value)" style="border:1px solid var(--border2);border-radius:5px;padding:3px 8px;font-size:12px;background:var(--surface);"><option value="geplant" ${w.status==='geplant'?'selected':''}>Geplant</option><option value="faellig" ${w.status==='faellig'?'selected':''}>F√§llig</option><option value="abgeschlossen" ${w.status==='abgeschlossen'?'selected':''}>Abgeschlossen</option></select></td><td style="white-space:nowrap;"><button class="btn btn-sm btn-edit" onclick="editItem('wartungen','${w.id}')">‚úèÔ∏è</button> <button class="btn btn-secondary btn-sm" onclick="deleteItem('wartungen','${w.id}')">üóëÔ∏è</button></td></tr>`).join(''):`<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">üîß</div><p>Keine Wartungsauftr√§ge</p></div></td></tr>`;
}

function renderGeraete() {
  let data=state.geraete;
  if(state.geraeteFilter==='aktiv') data=data.filter(g=>g.status==='aktiv');
  else if(state.geraeteFilter==='stoerung') data=data.filter(g=>g.status==='stoerung');
  const grid=document.getElementById('geraete-grid');
  grid.innerHTML=data.length?data.map(g=>`<div class="device-card"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;"><div style="font-size:28px;">${kIcons[g.kategorie]||'üîß'}</div><select onchange="changeGeraetStatus('${g.id}',this.value)" style="border:1px solid var(--border2);border-radius:5px;padding:2px 6px;font-size:11.5px;background:var(--surface);"><option value="aktiv" ${g.status==='aktiv'?'selected':''}>‚úÖ Aktiv</option><option value="stoerung" ${g.status==='stoerung'?'selected':''}>üî¥ St√∂rung</option><option value="wartung" ${g.status==='wartung'?'selected':''}>üü° Wartung</option><option value="ausser_betrieb" ${g.status==='ausser_betrieb'?'selected':''}>‚ö´ Au√üer Betrieb</option></select></div><div style="font-weight:600;font-size:14px;margin-bottom:4px;">${g.name}</div><div style="font-size:12px;color:var(--text3);margin-bottom:6px;">${g.standort||'‚Äì'}</div>${g.hersteller?`<div style="font-size:12px;color:var(--text3);margin-bottom:4px;">üè≠ ${g.hersteller}${g.seriennummer?' ¬∑ SN: '+g.seriennummer:''}</div>`:''}${g.naechsteWartung?`<div style="font-size:12px;color:${new Date(g.naechsteWartung)<new Date()?'var(--red)':'var(--text3)'};margin-bottom:4px;">üîß Wartung: ${fDate(g.naechsteWartung)}</div>`:''}${g.partnerName?`<div style="font-size:12px;color:var(--text3);margin-bottom:4px;">ü§ù ${g.partnerName}</div>`:''}${g.notizen?`<div style="font-size:11.5px;color:var(--text3);border-top:1px solid var(--border);padding-top:8px;margin-top:6px;">${g.notizen}</div>`:''}<div style="display:flex;justify-content:flex-end;gap:6px;margin-top:10px;"><button class="btn btn-sm btn-edit" onclick="editItem('geraete','${g.id}')">‚úèÔ∏è Bearbeiten</button><button class="btn btn-secondary btn-sm" onclick="deleteItem('geraete','${g.id}')">üóëÔ∏è</button></div></div>`).join(''):`<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">‚öôÔ∏è</div><p>Noch keine Ger√§te erfasst</p></div>`;
}

function renderPartner() {
  const grid=document.getElementById('partner-grid');
  grid.innerHTML=state.partner.length?state.partner.map(p=>`<div class="card"><div class="card-body"><div style="font-weight:600;font-size:15px;margin-bottom:4px;">${p.name}</div><div style="margin-bottom:12px;"><span class="badge badge-blue">${p.bereich}</span></div>${p.kontakt?`<div style="font-size:13px;margin-bottom:4px;">üë§ ${p.kontakt}</div>`:''}${p.telefon?`<div style="font-size:13px;margin-bottom:4px;">üìû <a href="tel:${p.telefon}" style="color:var(--accent);text-decoration:none;">${p.telefon}</a></div>`:''}${p.email?`<div style="font-size:13px;margin-bottom:4px;">üìß <a href="mailto:${p.email}" style="color:var(--accent);text-decoration:none;">${p.email}</a></div>`:''}${p.adresse?`<div style="font-size:12.5px;color:var(--text3);margin-bottom:4px;">üìç ${p.adresse}</div>`:''}${p.vertrag?`<div style="font-size:11.5px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:8px;">Vertrag: ${p.vertrag}</div>`:''}${p.notizen?`<div style="font-size:12px;color:var(--text3);border-top:1px solid var(--border);padding-top:8px;margin-top:4px;">${p.notizen}</div>`:''}<div style="display:flex;justify-content:flex-end;gap:6px;margin-top:10px;"><button class="btn btn-sm btn-edit" onclick="editItem('partner','${p.id}')">‚úèÔ∏è Bearbeiten</button><button class="btn btn-secondary btn-sm" onclick="deleteItem('partner','${p.id}')">üóëÔ∏è</button></div></div></div>`).join(''):`<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üè≠</div><p>Noch keine Partnerfirmen erfasst</p></div>`;
}

function renderNotfall() {
  const grid=document.getElementById('notfall-grid');
  grid.innerHTML=state.notfaelle.length?state.notfaelle.map(n=>`<div class="card" style="border-left:3px solid var(--red);"><div class="card-body"><div style="font-weight:600;font-size:15px;margin-bottom:6px;">${n.name}</div><div style="margin-bottom:12px;"><span class="badge badge-red">${n.kategorie}</span> <span class="badge badge-gray">${n.erreichbar}</span></div><div style="font-size:20px;font-weight:700;margin-bottom:8px;">üìû <a href="tel:${n.telefon}" style="color:var(--red);text-decoration:none;">${n.telefon}</a></div>${n.notizen?`<div style="font-size:12px;color:var(--text3);">${n.notizen}</div>`:''}<div style="display:flex;justify-content:flex-end;gap:6px;margin-top:10px;"><button class="btn btn-sm btn-edit" onclick="editItem('notfaelle','${n.id}')">‚úèÔ∏è Bearbeiten</button><button class="btn btn-secondary btn-sm" onclick="deleteItem('notfaelle','${n.id}')">üóëÔ∏è</button></div></div></div>`).join(''):`<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üö®</div><p>Noch keine Notfallkontakte</p></div>`;
}

function renderDokumente() {
  const tb=document.getElementById('dokumente-table');
  tb.innerHTML=state.dokumente.length?state.dokumente.map(d=>`<tr><td><span style="font-weight:500;">üìÑ ${d.name}</span></td><td><span class="badge badge-gray">${d.typ}</span></td><td>${d.geraetName||'‚Äì'}</td><td style="font-family:'DM Mono',monospace;font-size:12px;">${d.datum?fDate(d.datum):'‚Äì'}</td><td style="color:var(--text3);font-size:12.5px;">${d.notiz||'‚Äì'}</td><td style="white-space:nowrap;"><button class="btn btn-sm btn-edit" onclick="editItem('dokumente','${d.id}')">‚úèÔ∏è</button> <button class="btn btn-secondary btn-sm" onclick="deleteItem('dokumente','${d.id}')">üóëÔ∏è</button></td></tr>`).join(''):`<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üìÑ</div><p>Noch keine Dokumente</p></div></td></tr>`;
}

function renderAktivitaet() {
  const el=document.getElementById('aktivitaet-full');
  document.getElementById('log-count').textContent=state.log.length+' Eintr√§ge';
  el.innerHTML=state.log.length?state.log.map(l=>`<div class="activity-item"><div class="activity-dot" style="background:${l.color}"></div><div style="flex:1;"><div class="activity-text">${l.text}</div><div class="activity-time">${fTs(l.createdAt)}${l.user?' ¬∑ '+l.user:''}</div></div></div>`).join(''):'<div class="empty-state"><div class="empty-icon">üìã</div><p>Noch keine Aktivit√§ten</p></div>';
}

function updateBadges() { const n=state.tickets.filter(t=>t.status!=='erledigt').length,b=document.getElementById('ticket-count-badge');b.textContent=n;b.style.display=n>0?'':'none'; }

function filterTickets(f,btn){state.ticketFilter=f;btn.closest('.tabs').querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderTickets();}
function filterWartung(f,btn){state.wartungFilter=f;btn.closest('.tabs').querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderWartungen();}
function filterGeraete(f,btn){state.geraeteFilter=f;btn.closest('.tabs').querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderGeraete();}

function renderCalendar() {
  const year=state.calYear,month=state.calMonth;
  // Populate year dropdown (current year ¬±5)
  const ySel=document.getElementById('cal-year-select');
  if(ySel){
    const curY=new Date().getFullYear();
    if(!ySel.options.length||parseInt(ySel.options[0].value)!==curY-5){
      ySel.innerHTML='';
      for(let y=curY-5;y<=curY+5;y++) ySel.innerHTML+=`<option value="${y}">${y}</option>`;
    }
    ySel.value=year;
  }
  const mSel=document.getElementById('cal-month-select');
  if(mSel) mSel.value=month;
  document.getElementById('cal-header').innerHTML=['Mo','Di','Mi','Do','Fr','Sa','So'].map(d=>`<div class="cal-day-label">${d}</div>`).join('');
  const first=new Date(year,month,1),last=new Date(year,month+1,0),today=new Date();
  let sdow=first.getDay();if(sdow===0)sdow=7;
  const events=state.wartungen.filter(w=>{const d=new Date(w.datum);return d.getMonth()===month&&d.getFullYear()===year;});
  let cells=[];
  for(let i=1;i<sdow;i++) cells.push({date:new Date(year,month,1-(sdow-i)),curr:false});
  for(let i=1;i<=last.getDate();i++) cells.push({date:new Date(year,month,i),curr:true});
  while(cells.length%7!==0) cells.push({date:new Date(year,month+1,cells.length-last.getDate()-sdow+2),curr:false});
  document.getElementById('cal-body').innerHTML=cells.map(c=>{
    const isToday=c.curr&&c.date.getDate()===today.getDate()&&c.date.getMonth()===today.getMonth()&&c.date.getFullYear()===today.getFullYear();
    const de=events.filter(w=>new Date(w.datum).getDate()===c.date.getDate());
    return `<div class="cal-day ${!c.curr?'other-month':''} ${isToday?'today':''}"><div class="cal-day-num" style="${isToday?'color:var(--accent);font-weight:700;':''}">${c.date.getDate()}</div>${de.map(e=>`<div class="cal-event ${e.status==='abgeschlossen'?'badge-green':e.status==='faellig'?'badge-orange':'badge-blue'}">${e.bezeichnung}</div>`).join('')}</div>`;
  }).join('');
  const mev=[...events].sort((a,b)=>new Date(a.datum)-new Date(b.datum));
  document.getElementById('cal-events-list').innerHTML=mev.length?mev.map(w=>`<tr><td style="font-family:'DM Mono',monospace;font-size:12px;">${fDate(w.datum)}</td><td>${w.bezeichnung}</td><td>${w.geraetName||'‚Äì'}</td><td><span class="badge badge-gray">${w.typ}</span></td><td><span class="badge ${sBadge[w.status]}">${sLabel[w.status]}</span></td></tr>`).join(''):`<tr><td colspan="5"><div class="empty-state" style="padding:24px;"><p>Keine Wartungen in diesem Monat</p></div></td></tr>`;
}

function changeMonth(dir){state.calMonth+=dir;if(state.calMonth>11){state.calMonth=0;state.calYear++;}if(state.calMonth<0){state.calMonth=11;state.calYear--;}renderCalendar();}

setInterval(()=>{document.getElementById('clock').textContent=new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});},1000);
</script>
</body>
</html>
